#!/usr/bin/perl
use strict;
use warnings;
use Cwd 'abs_path';
use File::Basename;
use Getopt::Long qw(GetOptions);

# --------------------------------------------------------------------
# gtf2ensGene.pl
#
# Purpose:
#   Convert an Ensembl GTF into a genePred-like table and then
#   generate mRNA FASTA via gene2fa.pl.
#
# Pipeline:
#   1) gtfToGenePred:     GTF -> genePredExt table
#   2) process_genePred:  cleanup / normalize genePred table
#   3) gene2fa.pl:        genePred -> mRNA FASTA (needs seqdir now)
#   4) copy processed genePred to final hg{build}_ensGene.txt
#
# Requirements:
#   - UCSC gtfToGenePred installed (path configurable)
#   - process_genePred.pl exists in same folder as this script
#   - gene2fa.pl exists in same folder as this script (updated to accept --seqdir)
#   - hg19_GRCh37 mapping file exists in same folder as this script
#
# --------------------------------------------------------------------

my ($gtf, $build, $seqdir, $outdir, $help);
my $program = abs_path($0);
my $src_dir = dirname($program);

# Defaults (can be overridden via options)
my $gtf2GenePred = "/home/mingju/miniforge3/bin/gtfToGenePred";
my $hg2GRCh      = $src_dir . "/hg19_GRCh37";
my $process      = $src_dir . "/process_genePred.pl";
my $gene2fa      = $src_dir . "/gene2fa.pl";

GetOptions(
    'gtf|g=s'     => \$gtf,
    'build|b=i'   => \$build,
    'seqdir|s=s'  => \$seqdir,
    'outdir|o=s'  => \$outdir,
    'help|h'      => \$help,
) or die usage($program);

if ($help) {
    print usage($program);
    exit 0;
}

# Required arguments
if (!$gtf || !$build || !$seqdir) {
    die usage($program);
}

# Validate inputs
if (!-e $gtf) {
    die "ERROR: GTF file not found: $gtf\n";
}

if ($build != 19 && $build != 38) {
    die "ERROR: --build must be 19 or 38 (got: $build)\n";
}

if (!-d $seqdir) {
    die "ERROR: --seqdir must be an existing directory (got: $seqdir)\n";
}

# Output directory: default to same folder as GTF
if (!$outdir) {
    $outdir = dirname($gtf);
}
if (!-d $outdir) {
    die "ERROR: --outdir does not exist: $outdir\n";
}

# Dependency checks
for my $f ($gtf2GenePred, $hg2GRCh, $process, $gene2fa) {
    if (!-e $f) {
        die "ERROR: Required file does not exist: $f\n";
    }
}

# Construct intermediate + final file paths
my $gtf_gene          = $gtf . "_GenePred";          # raw genePred
my $predGene_process  = $gtf_gene . "_process";      # processed genePred
my $final             = $outdir . "/hg" . $build . "_ensGene.txt";

# -----------------------
# Step 1: gtfToGenePred
# -----------------------
my $cmd1 = "$gtf2GenePred -genePredExt -geneNameAsName2 $gtf $gtf_gene";
run_cmd($cmd1);

# -----------------------
# Step 2: process genePred
# -----------------------
my $cmd2 = "perl $process $hg2GRCh $gtf_gene";
run_cmd($cmd2);

# -----------------------
# Step 3: genePred -> FASTA (UPDATED: include seqdir)
# Assumed new signature:
#   perl gene2fa.pl <genefile> <seqdir> <build> <db>
# -----------------------
my $cmd3 = "perl $gene2fa $predGene_process $seqdir ensGene $build";
run_cmd($cmd3);

# -----------------------
# Step 4: copy processed genePred to final output
# -----------------------
my $cmd4 = "cp $predGene_process $final";
run_cmd($cmd4);

print STDERR "\nDone.\n";
print STDERR "Final gene table: $final\n";
print STDERR "FASTA output is generated by gene2fa.pl in the same folder as input (depending on gene2fa.pl logic).\n";

exit 0;


# -----------------------
# Helper: run command with error check
# -----------------------
sub run_cmd {
    my ($cmd) = @_;
    print STDERR "Running:\n  $cmd\n";
    my $ret = system($cmd);
    if ($ret != 0) {
        die "ERROR: Command failed (exit code " . ($ret >> 8) . "):\n  $cmd\n";
    }
}

# -----------------------
# Helper: usage message
# -----------------------
sub usage {
    my ($prog) = @_;
    return <<"USAGE";

Usage:
  perl $prog --gtf <file.gtf> --build <19|38> --seqdir <reference_fasta_dir> [--outdir <output_dir>]

Required arguments:
  --gtf,    -g   Input GTF file (e.g. Homo_sapiens.GRCh38.113.gtf)
  --build,  -b   Genome build: 19 or 38
  --seqdir, -s   Directory containing reference FASTA files for the build
                 (e.g. hg19_reference_dir or hg38_reference_dir)

Optional:
  --outdir, -o   Output directory (default: same directory as the GTF)
  --help,   -h   Show this help message

What it produces:
  1) Intermediate genePred file:
       <GTF>_GenePred
  2) Processed genePred file:
       <GTF>_GenePred_process
  3) Final gene table copied to:
       <outdir>/hg<build>_ensGene.txt
  4) FASTA file generated by gene2fa.pl (location depends on gene2fa.pl)

Example:
  perl $prog \\
    --gtf /path/to/Homo_sapiens.GRCh38.113.gtf \\
    --build 38 \\
    --seqdir /mnt/10T-backup-mingju/ifar/databases/hg38/reference/chromfa/

USAGE
}

